"use strict";angular.module("grapheneTidalApp",["sg.graphene"]),angular.module("grapheneTidalApp").controller("MainCtrl",["$scope","$window",function(a,b){b.myCb=function(){console.log("layout complete")},a.nodeSize={min:{width:80,height:30},max:{width:160,height:60}},a.subgraph={height:200,width:800},a.layoutComplete="myCb",a.charge=-1200,a.jsonUrl="sampleJSONwithProps.json",a.linkDistance=80;var c={focused:1,unfocused:.1,normal:.6},d=function(a){console.log("Clicked on "+a.name)},e=function(a){console.log("Double clicked on "+a.name)},f=function(a,b,d){var e=d.target;console.log("mousing over",e),a.opacity=c.focused,_.each(b.imports.nodes,function(b){b.id!==a.id&&(b.opacity=c.unfocused)}),_.each(b.imports.edges,function(b){b.source.id!==a.id&&b.target.id!==a.id?b.opacity=c.unfocused:(b.opacity=c.focused,b.target.opacity=c.focused,b.source.opacity=c.focused)})},g=function(a,b){_.each(b.imports.groups,function(a){_.each(a.nodes,function(a){a.opacity=c.normal})}),_.each(b.imports.edges,function(a){a.opacity=c.normal})};a.events={click:d,dblClick:e,mouseover:f,mouseleave:g}}]),angular.module("grapheneTidalApp").controller("sgTidalDataCtrl",["$scope","$http","$window",function(a,b,c){a.callWindowFunction=function(a){_.isFunction(c[a])&&c[a]()},a.$watch("jsonUrl",function(d){d&&b.get(a.jsonUrl).success(function(b){a.data=b,c.copy=angular.copy(b)})}),a.$watch("json",function(b){b&&(a.data=a.json)});var d=function(a){var b=new Blob([a],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(b)};a.svgToUrl=function(){var b=c.document.querySelector("svg"),e=new XMLSerializer;a.svgUrl=d(e.serializeToString(b))},a.$watch("data",function(b){if(b){var c=b;a.edges=_.map(c.edges,function(a){return{source:_.find(c.nodes,function(b){return b.id===a.nodes[0]}),target:_.find(c.nodes,function(b){return b.id===a.nodes[1]}),type:a.type}});var d=c.timeSlots,e=_.keys(d).sort(function(a,b){var c=/[^a-zA-Z]/g,d=/[^0-9]/g,e=a.replace(c,""),f=b.replace(c,"");if(e===f){var g=parseInt(a.replace(d,""),10),h=parseInt(b.replace(d,""),10);return g===h?0:g>h?1:-1}return e>f?1:-1}),f={};f.max=_.max(c.nodes,function(a){return a.size}),f.min=_.min(c.nodes,function(a){return a.size}),a.groups=[];var g=0,h=0;_.each(e,function(b){var e=d[b],i=_.filter(c.nodes,function(a){return _.contains(e,a.id)});_.each(i,function(b){b.group=g,b.scaleFactor=(b.size-f.min.size)/(f.max.size-f.min.size),b.width=a.nodeSize.min.width+(a.nodeSize.max.width-a.nodeSize.min.width)*b.scaleFactor,b.height=a.nodeSize.min.height+(a.nodeSize.max.height-a.nodeSize.min.height)*b.scaleFactor});var j=_.filter(a.edges,function(a){return _.contains(e,a.source.id)&&_.contains(e,a.target.id)}),k=d3.layout.force().charge(a.charge||-700).linkDistance(a.linkDistance||40).gravity(a.gravity||.1).size([a.subgraph.width||800,a.subgraph.height||800]);_.each(i,function(a){a.force=k});var l=!1;k.nodes(i).on("tick",function(){a.subgraph.height&&a.subgraph.width&&(_.each(i,function(b){b.x=Math.max(b.width,Math.min(a.subgraph.width-b.width,b.x)),b.y=Math.max(b.height,Math.min(a.subgraph.height-b.height,b.y))}),l||(a.$digest(),l=!0));var b=a.layoutStopThreshold||.01;k.alpha()<=b&&(k.stop(),a.$digest(),a.layoutComplete&&(h+=1,h===a.groups.length&&a.callWindowFunction(a.layoutComplete)))}).start(),a.groups.push({nodes:i,links:j,name:b}),g+=1}),a.exports={groups:a.groups,edges:a.edges,subgraph:a.subgraph,events:a.events}}})}]),angular.module("grapheneTidalApp").controller("sgTidalLayoutCtrl",["$scope","sgGeo",function(a,b){a.spacer=10;var c=function(c){var d=b.getLineIntersectionWithRectangle({x1:c.source.x,y1:c.source.y+c.source.group*a.imports.subgraph.height,x2:c.target.x,y2:c.target.y+c.target.group*a.imports.subgraph.height},{x1:c.source.x-(c.source.width/2+a.spacer),y1:c.source.y-(c.source.height/2+a.spacer)+c.source.group*a.imports.subgraph.height,x2:c.source.x+c.source.width/2+a.spacer,y2:c.source.y+c.source.height/2+a.spacer+c.source.group*a.imports.subgraph.height}),e=b.getLineIntersectionWithRectangle({x1:c.source.x,y1:c.source.y+c.source.group*a.imports.subgraph.height,x2:c.target.x,y2:c.target.y+c.target.group*a.imports.subgraph.height},{x1:c.target.x-(c.target.width/2+a.spacer),y1:c.target.y-(c.target.height/2+a.spacer)+c.target.group*a.imports.subgraph.height,x2:c.target.x+c.target.width/2+a.spacer,y2:c.target.y+c.target.height/2+a.spacer+c.target.group*a.imports.subgraph.height});c.x1=d.x,c.y1=d.y,c.x2=e.x,c.y2=e.y};a.$watchCollection("imports.edges",function(b){b&&(a.links=a.imports.edges,_.each(a.links,function(b){a.$watch(function(){return b.source.x+b.source.y+b.target.x+b.target.y},function(){c(b)}),c(b)}))}),a.arrow=d3.svg.symbol().size(function(a){return a.size}).type(function(a){return a.type}),a.clickNode=function(b,c){var d=a.imports.events.click;_.isFunction(d)&&d(b,a,c)},a.dblClickNode=function(b,c){var d=a.imports.events.dblClick;_.isFunction(d)&&d(b,a,c)},a.mouseoverNode=function(b,c){var d=a.imports.events.mouseover;_.isFunction(d)&&d(b,a,c)},a.mouseleaveNode=function(b,c){var d=a.imports.events.mouseleave;_.isFunction(d)&&d(b,a,c)}}]);